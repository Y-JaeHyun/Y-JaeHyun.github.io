---
layout:     post
title:      블록체인 펼쳐보기 - 3
author:     bcnote3314
tags: 		blockchain 블록체인펼쳐보기
subtitle:  블록체인 정복기	
category: Block
---

# 블록체인 펼쳐보기 - Chapter 04

블록체인 펼쳐보기 챕터 4에 대한 내용 정리

## P2P 네트워크(p2p network)

토렌트를 사용하여 파일을 주고받으수 있게 해주는 기술
여러개의 컴퓨터에 흩어져있는 파일의 조각들을 수집하여 전체 파일을 구성하는 방식으로 전송처리를 한다.

반대로 내가 가진 조각을 다른 사용자에게 전달하는 역할도 한다.
이 작업에 참여하는 것은 자발적으로 이루어지며 감독기관, 인증 절차도 전혀 필요 없다.

블록체인도 P2P 네트워크를 활용하며 여기에 참여한 컴퓨터를 노드(node)라고 표현한다.

>노드는 일반사용자가 아니다. 일반 사용자는 지갑 응용프로그램을 이용해서 코인을 사고 파는 등의 행위를 하며 노드는 비트코인 프로그램을 통하여 블록의 전파와 검증등을 수행하는 컴퓨터이다.

노드들은 전세계에 퍼져있으며 인접한 노드의 중계에 의하여 데이터를 전파한다.
현재 블록체인에는 약 수천개(가변적)의 노드들이 존재하는데 새로운 블록을 전파하는데 1분 이내로 처리가 가능하다.

각 노드에는 모든 거래가 기록된 장부를 한벌씩 가지고 있기 때문에 독자적으로 동작하며 새로운 블록이 생성되었을때 각자 자신의 체인 끝에 추가하고 전달하는 과정을 거친다.

>블록체인의 종류의 따라 네트워크 형태도 조금씩 다르다.
모든 노드가 동일한 형태의 퓨어 P2P와 각각 역할을 다르게 설정된 슈퍼노드의 존재, 일부 인ㄴ덱스 서버 역할등을 해주는 하이브리드  P2P 등 성격에 맞게 사용한다.


## 채굴(mining)

블록체인의 P2P 네트워크에 연결된 노드들은 독자적으로 동작하며 블록을 전파한다고 했지만 그외에 직접 새 블록을 만들 수 있다.

블록체인 네트워크에는 블록 말고도 거래내용들도 같이 돌아다니는데, 노드에서는 이 거래장부를 모아서 페이로드에 기록하며, 자신이 가진 장부의 최상위 블록헤더의 해시값과 페이로드의 해시값을 적고 Nonce값을 찾기 위한 작업을 수행한다.

자신이 앞자리 40비트가 0이되는 Nonce값을 찾는동안 다른 노드로부터 이미 새 블록이 만들어졌다는 소식이 없다면 이 블록을 지지하는 노드들을 구하기 위해 재빨리 전파해야한다.

전파가 완료되고 지지를 받아 내블록위에 다른 블록들이 쌓인다면 채굴이 성공한 것이다.
채굴을 성공하고나면 보상금을 받게되며 이 보상금은 어디에 없던 새로운 코인이다. (최대 발행량은 정해져 있기 때문에 고갈후에는 발행않게된다. (수수료를 통하여 보상획득?)

비트코인에서 블록의 생성주기는 10분이다. 즉 10분마다 Nonce값을 찾기 위한 경쟁을 하게되며 1등이 상품을 독점한다. 비슷한 시점에 Nonce를 찾은 노드가 여러 개 있을수 있다. 
노드간의 장부의 정합성이 맞지 않는 케이스인데 블록체인에는 이에 대한 대비도 되어있다. (to be continue…)


## 자동 난이도 조정

비트코인은 기본적으로 10분에 한 개씩 새로운 블록이 채굴되도록 설계되어있다.
하지만 이것은 평균치이며 실제로는 1초만에 될수도 더 오래걸릴수도 있다. (당연히 Nonce값을 우연하게 찾는것이기 때문이고.)

하지만 채굴에 참여하는 노드의 수, 컴퓨터의 성능등의 변화가 존재하기 때문에 항상 10분 평균을 유지하기 어렵다.
즉 난이도가 상황에 따라 변경되야 한다.

난이도의 변경은 이전에 잠깐 스쳐 지나간 내용과 비슷하다. 
블록체인에서는 SHA 256 버전을 사용하며 난이도를 해시캐시 보다 어렵게 하기 위하여 앞자리 0의 개수를 20비트에서 40비트로 증가 시켰다고 했었다.
즉 앞자리 0인 비트가 늘어나면 난이도가 증가하며 줄어들면 난이도가 감소하는 것이다.
이전에 설명에 나온바와같이 전체 사이즈 2^256-20^ = 2^236^보다 작은 값을 찾는 것보다. 2^256-40^ = 2^216^보다 작은 값을 찾는것이 어려운것은 당연하다. (만족하는 값의 범위가 줄었잖아.)

블록헤더에는 nBits라는 32비트 값이 들어가는 필드가 존재한다. 이 필드값이 난이도를 나타낸다.
그 중 맨앞 1바이트(8비트)는 앞쪽 0으로 채워지는 바이트를 제외한 총 바이트의 수다. 또한 뒤에 나머지 3바이트는 숫자로 채울 바이트들중 맨 앞 3바이트에 들어갈 값이다.

예를들어 nBit가 0x1b0404cb라고 하면 1b = 27이기 때문에 27바이트가 실제 숫자로 채워지는 영역이다. 또한 27바이트중 앞에 3바이트의 값이 0x0404cb가 되는 것이며, 32바이트(256 비트) 중 나머지 5바이트가 앞에 0으로 채워지는 부분인것이다.

비트코인에서는 2016개의 블록이 쌓일때마다 난이도를 조정하도록 하였다. 즉 10분에 한개이기 때문에 20160분이 걸리는 것이 평균인데 그 처리 시간에 따라 목표치를 변경하는 방식이다. (환산하면 약 2주정도의 시간이다.)

