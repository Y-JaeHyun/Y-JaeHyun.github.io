---
layout:     post
title:      Xen으로 배우는 가상화 기술의 이해(CPU 가상화) -1
author:     bcnote3314
subtitle:  	가상화 기술 이해
tags: 		virtualization
category: Note
---

## Xen 으로 배우는 가상화 기술 이해

가상 머신 모니터의 원리부터 Xen 하이퍼 바이저를 통해 가상화에 대한 전반적인 부분을 다룬다.  
CPU 가상화, 메모리 가상화, I/O가상화 세가지 시리즈로 나누어 설명한다.

첫번째 파트는 CPU 가상화로 Xen에서 전통적으로 사용하는 반가상화 기법과 하드웨어 지원 가상화 기술을 활요하는 전가상화 기법에 대해서 다루며, 실제 CPU를 어떻게 나누어 활용하는지 가상머신 스케쥴링에 대하여 공부한다.  

가상화를 공부하는 이유는 최근 클라우드가 대두되면서 상당히 많은 곳에서 가상화에 대한 요구가 많다.  
실제 내가 다니는 회사에서도 5G의 대부분의 기능들이 클라우드와 가상화로 귀결되면서 물리적인 제품 자체가 클라우드의 형태로 제공되어야 한다는 니즈도 있다. (물론 진행이 잘되고 있는지는...)  

앞으로도 많은 서비스, 제품, 기능들이 클라우드와 가상화라는 이름아래에서 제공될것들이 많기 때문에 미래를 위해서 공부해두는 것이 좋을것 같다.   


## 가상 머신 모니터(하이퍼 바이저)

가상 머신 모니터, 자주 쓰이는 다른말로 하이퍼바이저(Hyperviso)라고도 한다.  
단어 그대로 가상머신을 모니터링하는 소프트웨어이며, 하드웨어 자원관리, 가상머신 스케쥴링등의 작업을 담당한다.

가상 머신 모니터는 시스템 위치에 따라 크게 Type1과 Type2로 분류된다.  
Type1은 하드웨어 바로위에 소프트웨어 계측으로 존재하는 것으로 서버용 하이퍼 바이저가 주로 여기에 해당한다. (Xen 포함)
Type2는 Host의 운영체제가 별개로 존재하며 그위에 하이퍼바이저가 있는 형태이며 버추얼박스, VMware등 PC의 어플리케이션 형태로 제공되는 형태이다.

Xen의 경우 Type1에 해당하는 하이퍼바이저로 아마존에서도 기본으로 채택해서 사용할 만큼 안정성과 성능이 어느정도 검증되어있다.

## CPU 가상화

시스템을 가상화하는 두가지 방법이 있다.  
첫번쨰는 에뮬레이션 기법이다.  

MAME, Gameboy 와 같은 예전 오락기 에뮬레이터나 안드로이드 기반의 SDK 에뮬레이터 등을 생각하면 편하다.  
실제 해당 디바이스는 없지만 에뮬레이터를 통하여 프로그램을 PC에서 실행시킬 수 있다.  

에뮬레이터는 이미지를 스캔해 역어셈블을 통하여 ARM 명령어를 추출하고 x86 시스템에서 동작할 수 있도록 번역하여 가상머신 위에서 동작시키는 방식이다.  
그만큼 성능이 저하되는 경우가 많다. 

두번째 방법은 직접 실행하는 방법이다.  
바이너리 프로그램을 번역과정 없이 직접 CPU에서 실행하는 것으로 가상화 환경이 아닌것처럼 CPU가 직접 실행하게 하는 것이다.  
하지만 역시 좋은것은 어렵기 마련이다.. 직접실행 방식으로 하이퍼바이저를 구현할 때는 많은 문제점이 존재한다.

## 특권 모드와 비특권 모드

요즘 운영체제는 모두 특권모드라고 불리는 실행 모드가 존재한다.  
비특권 모드에서 실행되는 프로그램은 특권모드의 프로그램과 데이터에 접근할 수 없다.  

일반적으로 응용프로그램은 비특권 모드이며, 운영체제 커널이 특권모드이다.  
응용프로그램이 시스템의 자원을 사용하기 위하여 시스템 콜을 통해 운영체제에 요청하는 것은 이때문이다.  

만약 응용프로그램이 시스템 자원에 접근하려 한다면 Segmentation Fault와 같은 에러가 발생하며 프로그램이 종료되면서 시스템의 영향을 끼치는것을 막는다.  

특궈너 명령은 특권 모드에서만 실행 가능한 명령어를 의미하며 트랩은 divide 0, break point 등과 같은 이벤트를 만났을때 프로그램의 제어권이 트랩 핸들러로 넘어가는 것을 의미한다.  

## 전통적인 하이퍼 바이저 구현 방법

하이퍼 바이저는 다수의 게스트 운영체제를 다루기 때문에 운영체제보다 더높은 특권을 가져야 한다.  
만약 동일한 위치의 특권을 가진다면 다수의 운영체제에서 동시에 시스템 자원을 사용하면서 발생하는 오류를 막을수 없다.  

그렇기 떄문에 하이퍼바이저를 특권모드, 운영체제를 비특권 모드에서 실행하게 된다.  
비특권 모드에서 발생하는 운영체제가 특권 명령을 수행하면 트랩이 발생하여 하이퍼바이저로 제어권을 넘기며, 하이퍼바이저는 관련 루틴을 에뮬레이트 하고 다시 운영체제로 제어권을 넘기는 형태이다.  

하지만 시스템 오버헤드가 크고, 특권명령과 비특권 명령의 경계가 모호한 명령들이 다수 존재했다.  

## 바이너리 변환, 하이퍼 콜

VMWare에서 제시한 바이너리 변환, Xen에서 사용하는 하이퍼콜이 전통적 하이퍼 바이저 구현방법의 문제점을 해결해 준다.

바이너리 변환은 운영체제의 코드 이미지를 하이퍼바이저가 스캔해 문제가 있는 명령ㄹ어들을 검출하여 직접 수정하여 실행한다.  
CPU에서 직접 실행하는 방법이지만 중간에 번역과정을 추가한 형태이다.  

하이퍼 콜은 반가상화 기술의 일종으로 Xen에서 사용하는 방식이다.  
직접 운영체제의 소스를 수정하여 문제의 소지가 있는 명령어를 제거한다.  
그리고 하이퍼 바이저로 호출할 수 있는 하이퍼콜로 바꾸어서 문제의 소지가 있는 명령어가 실행될 시점에 하이퍼바이저로 제어권을 넘긴뒤 하이퍼 바이저가 해당 요청을 처리하여 되돌려주는 방식이다.  

## 하드웨어 기능 활용

가상화에 대한 요구가 점점 늘어나면서 CPU 벤더사에서 가상화 관련 기능들을 추가했다.  
인텔의 VT-x, AMD의 SVM 등이 해당 기술이며 벤더마다 아키텍쳐는 조금씩 다르지만 전체적인 개념은 비슷하다.  
해당 기능들을 사용하면 트랩과 에뮬레이트 방식으로 하이퍼 바이저를 구현 가능하다.

핵심은 기존의 특권 / 비특권 모드에서 하이퍼바이저를 위한 Roo / Non-root 모드를 추가한 것이다.  
특권모드의 상위 개념을 추가하여 Root 모드에서는 하이퍼바이저가 Non-root의 특권 모드에서는 게스트 운영체제가, Non-root의 비특권 모드에서는 애플리케이션이 동작하도록 한다.  
이때 앞에서 나온 경계가 모호한 명령이 수행되면 Non-root에서 트랩을 통해 Root로 제어권을 넘기는 형태로 하드웨어에서 지원하는 형태이다.

## Paravirt Operation, 하이퍼콜

반가상화(Paravirtualization) 기법은 운영체제의 소스코드를 수정해서 가상화를 구현한다.  
이를통해 운영체제와 하이퍼바이저 사이의 협력을 극대화해 가상화 시스템의 고성능 화를 실현한다.
각 하이퍼 바이저 벤더에서는 반가상화 기법을 제공하기 시작했으며, Xen에서는 하이퍼콜 인터페이스를 통하여 제공한다.

각 가상화 솔루션 벤더에서 반가상화 인터페이스를 따로 만들어 리눅스 커널을 수정하게 되면서 소스코드의 복잡성이 늘어나고 관리가 되지 않는 문제가 생겼다.  

리눅스에서는 공통 API를 제공하고 하이퍼바이저 벤더에서 해당 API에 맞춰 인터페이스를 구현하도록 하였고 이것을 paravirt operation 라고 한다.


......


## 멘붕

여기서부터 커널 관련 로직이 나온다.  
어셈블리 코드부터해서 굉장히 low한 영역에 대한 설명이다.  

음... 머리가 아프다... 


To be continue.