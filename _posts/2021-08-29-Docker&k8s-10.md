---
layout:     post
author:     bcnote3314
title: 쿠버네티스를 통한 클라우드 저장소
category: Note
tags: 		Docker&k8s
---

나는 기존에 라즈베리파이에 samba를 통해 자료들을 관리해왔다.  
하지만 smb 자체가 외부에서 사용하기에 보안상 안전하지 못한 케이스가 많았고, 외부에서 접근하기 위해 VPN등을 통하고는 했었다.  

쿠버네티스를 통해서 간단하게 samba를 대체할만한 클라우드 저장소를 구축하고 이를 기반으로 쿠버네티스에 대한 이해를 점진적으로 넓혀가고자 한다.  


# NextCloud

오픈소스 기반의 클라우드 스토리지 소프트웨어이다. 
k8s의 경우 자체적으로 컨테이너 이미지를 관리하지 않으며 도커의 이미지를 사용한다.

## 1. NextCloud 이미지 다운로드
```
$ docker pull nextcloud
$ docker images
REPOSITORY                           TAG       IMAGE ID       CREATED        SIZE
nextcloud                            latest    8f3e0cc72ede   5 days ago     808MB
k8s.gcr.io/kube-apiserver            v1.22.1   ea2469613c8c   2 weeks ago    105MB
k8s.gcr.io/kube-controller-manager   v1.22.1   216cfd23ec09   2 weeks ago    100MB
k8s.gcr.io/kube-proxy                v1.22.1   ba0805166141   2 weeks ago    79.7MB
k8s.gcr.io/kube-scheduler            v1.22.1   a9073ff47fe0   2 weeks ago    44.7MB
k8s.gcr.io/etcd                      3.5.0-0   1a771bad15fc   2 months ago   332MB
k8s.gcr.io/coredns/coredns           v1.8.4    72d94efa1c31   3 months ago   39.3MB
quay.io/coreos/flannel               v0.14.0   98c20ac699d3   3 months ago   59MB
k8s.gcr.io/pause                     3.5       81cb2d500ca0   5 months ago   325kB
svendowideit/ambassador              latest    8f4da6f7d98a   5 years ago    8.03MB
relateiq/redis-cli                   latest    e708677944bb   7 years ago    334MB

```

## 2. k8s namespace 설정

네임스페이스는 k8s 내에서 별도의 작업공간을 구분하기 위한 설정이다.  
네임스페이스를 지정해서 수행한 명령들은 해당 네임스페이스에면 영향력을 끼치며, 만약 문제가 생긴 경우에도 해당 네임스페이스만 지우거나, 수정해주면 된다.  
만약 지정하지 않는다면 default 네임스페이스에 관련 동작이 수행된다.  

```
$ kubectl create namespace mycloud
```

## 3. Deployment 

디플로이먼트는 k8s에서 일반적인 상태가 없는(stateless) 어플리케이션을 배포하기 위해 사용하는 컨트롤러이다.  
배포와 관련된 기능이 세분화되어 있고, pods의 개수 유지 및 버전 관리등 다양한 작업에 사용된다.  

도커 이미지를 통해 기본적인 deployment를 생성이 가능하다.  

```
$ kubectl create deployment nextcloud-test --image=nextcloud -n mycloud
$ kubectl get deploy -n mycloud
NAME             READY   UP-TO-DATE   AVAILABLE   AGE
nextcloud-test   1/1     1            1           3d23h
$ kubectl get pods -n mycloud
NAME                              READY   STATUS    RESTARTS   AGE
nextcloud-test-6444f9fcfd-z4zvw   1/1     Running   0          3d23h
```

deployment 생성 이후 파드를 확인해보면 기본 설정값에 따라 1개가 올라와있는 것을 확인 할 수 있다.  

