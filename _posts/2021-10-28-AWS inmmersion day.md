---
layout:     post
author:     bcnote3314
title: AWS immersion Day
category: Cloud
tags: 		AWS
---

# AWS Immersion Day

IPS 가상화 관련 프로젝트를 진행하면서 Private Cloud가아닌 Pubillc Cloud에서도 동일한 서비스를 제공해야했다.  
Docker 컨테이너 기반으로 프로젝트를 진행했기 때문에 AWS EC2위에 도커를 올리고 IPS를 동작시키는 형태는 가능했다.  

다만 기존에 ovs-dpdk, vhost등 Application 밑단의 네트워크 구성등은 일부 변경이 있었다. 
ASW를 조금 만지작 거리다 보니 AWS에서 제공하는 다양한 기능, 서비스 들이 눈에 보였고 이에 관심이 생겨 AWS에서 진행하는 교육을 들어봤다.

사실 서비스의 개념보다는 전체적인 서비스 아키텍쳐 구성에 대해서 배울수 있는 좋은 시간이였던것 같다.  

그중에 일부 내가 자주 사용할것 같은것에 대해서 좀 정리해 둔다.  

아래 실습자료는 참고하면 도움이 많이 될것같다.  

[AWS - 실습 자료](https://kr-id-general.workshop.aws/ko/advanced_modules.html)

# Amazon VPC

Virtual Private Cloud, 가상의 네트워크를 구성할수 있도록 도와준다.  
인터넷에서 서비스를 제공하기 위해서는 당연히 공인 IP가 필요하다.  

AWS의 과금 정책에 따라 다수의 공인 IP를 사용하는 것보다는 네트워크 구성을 이용하여 최소한의 비용으로 서비스를 구축하는 것이 중요할 수 있다.  

VPC는 크게 Public 영역과 Private 영역으로 구분된다.  
Public 영역은 IGW(Internet Gateway)을 통해 외부 인터넷과 통신이 가능한 영역이다.  
Private은 기본적으로는 내부에 숨겨져있어서 인터넷 통신이 불가능하며 VPC 내의 자원끼리의 통신만 가능하다.  
(하지만 뭐 당연하게도 불가능한것은 아니며 NAT Gateway 통해 인터넷 접근을 허용할 수는 있다.)

Public/Private을 나누는 기준은 다른 것이 아니라 결국 라우팅 테이블이다.  
IGW로 향하는 정책이 있으면 결국 Public이고 없으면 Private다.  

VPC 설정을 하다보면 Availability Zone(가용영역)이 나온다. (이전 Post 참고)
하나의 리전에는 두개 이상의 가용영역이 존재하며 이들은 모두 격리되어있지만 서로 연결되어있다.  
하나의 가용영역에서 장애가 발생하면 다른 가용영역의 인스턴스에서 요청에대한 처리를 진행하게 된다.  

즉, 고가용성을 위한 HA구성으로 Subnet을 추가 구성하여 두개의 존에서 내 VPC 인스턴스들을 동작 시킬수 있다.
Subnet을 각기다른 Zone에 추가 구성하게 되면 라우팅 테이블을 통해 네트워크 구성을 해줘야 한다.

# Amazon EC2

VPC를 통해 가상 네트워크를 구성했고, 해당 네트워크에 이제 인스턴스를 배치하는 일이 남았다.  
EC2 생성시에 Network와 Subnet 부분에 대해서 신경을 써줘야한다.  

Advanced Detail 영역에서는 인스턴스 생성시 수행할 명령을 쉘 스크립트 형태로 미리 작성할 수 있다.  
초기 셋팅과 관련된 부분을 미리 작성해두면 모든 인스턴스에 동일한 초기 상태를 만드는데 용이할것 이다.  

Security Grop 설정은 보안 그룹을 만들거나 기존에 만들어진 그룹을 선택하여 적용할 수 있다. (방화벽 정책)  

## AMI

최초 만들어진 인스턴스를 통해 이미지를 생성 할 수 있다.  
이미지를 통해서 추후에 동일한 인스턴스를 생성할 수 있으며 이를 AMI라고 부른다.  


# 오토 스케일링 웹서비스

오토 스케일링은 서비스 부하 상황에 따라 자동으로 Scale Out/In이 가능하고 고가용성이 보장되는 것을 의미한다.  

## Application Load Balancer 생성

AWS에서 제공하는 로드 밸런서 3가지중 하나이다.  
해당 실습에서는 HTTP 요청에 대해 부하를 분산해주는 ALB를 구성하는 방법에 대해 설명한다.  

Listeners : Listening 할 프로토콜과 포트를 지정한다.  
Availability Zone : 가용 영역을 지정한다.  고가용성을 보장하기 위해서 서로다른 가용 영역에 네트워크에서 생성한 서브넷을 연결한다. 
Security Group : 방화벽 설정이다. HTTP 트래픽에 대해서는 허용이 필요하다.  
Routing, Target : 트래픽을 넘겨줄 대상을 설정한다. (아직 인스턴스가 없기 떄문에 이름만 설정한다.)

## 시작 템플릿 생성

ALB 뒤에는 실제 인스턴스가 배치되어야 한다.  
Auto Scaling Group에서 인스턴스를 생성하기 위해 시작 템플릿을 사용한다.  

시작 템플릿은 모든 시작 파라미터를 구성하기 때문에 인스턴스 생성에 필요한 단계수를 줄여준다.  
AMI 및 인스턴스 유형과 같은 정보들을 포함하며 Auto Scaling Group에서는 이를 참조하여 Scale Out 처리를 하게 된다.  

우선 적으로 시작 템플릿에 의해 생성될 인스턴스들이 참조할 Security Group을 만들어야 하며 Inbound 에 대해서는 Load Balancer에서 유입되는 HTTP 트래픽만 받으며 Outbound는 모든 트래픽을 전달하도록 구성한다.  

그외에는 딱히 특별할건 없다. AMI와 인스턴스를 선택하고 Network 셋팅에서는 VPC를 선택하고 생성한 Security Group을 지정해 주면된다.  

## 오토스케일링 그룹 구성

오토스케일링 그룹에서는 이전에 생성한 시작 템플릿을 선택한다.  
또한 VPC와 Subnet을 이전에 만둘어든 네트워크에 맞게 설정한다. (Subnet은 Private을 사용한다.)
Advance option에서는 이미 생성한 로드밸런스가 있기 때문에 해당 로드밸런스의 타겟그룹을 설정한다.  
Scaling Policy는 기본 유지하는 인스턴스 개수와 최소 최대 개수를 지정하며 Scale In/Out을 결정하는 정보를 입력한다.  
CPU, Memory 사용량 등을 선택할 수 있으며 사용량이 지정한 값에 도달하면 Scale Out하는 형태이다.  

# 데이터 베이스(Amazon RDS)

AWS에서는 다양한 데이터베이스 서비스를 제공하며 다양한 상용 데이터베이스 엔진과의 호환성을 지원한다.  
RDS는 관계형 데이터베이스 서비스이며 구성과 운영이 간편하다.  

RDS는 EC2와 동일하나 형태의 보안모델을 사용한다.  
기존의 EC2에서와 같이 VPC 보안그룹을 활용해야 한다.  

Database를 위한 Security Group을 우선 추가한다.  
Inbound의 경우 사용하는 db 타입을 선택하면 자동으로 해당 프로토콜과 포트가 선택되며 소스는 이전에 생성한 EC2 인스턴스용 시큐리티 그룹을 선택해야한다.  
OutBound는 모든 트래픽을 허용한다.  

다음은 RDS 인스턴스를 생성한다.  
디비 엔진을 선택하고, DB 접근을 위한 계정정보, 인스턴스 사이즈를 결정한다.  
또한 DB의 경우도 Availability를 위하여 다른 하나의 가용영역에 읽기전용 복제노드를 구성하게된다. (기본값으로 설정되어있다.)  

그 후엔 네트워크 및 보안설정을 통해 인스턴스 생성이 완료된다.  

## EC2 인스턴스 추가설정

데이터베이스가 생성되고나면 Write Role을 가진 DB 인스턴스의 endpoint name과 인스턴스 생성과정에서 정한 계정 정보가지고 EC2와 연결한다. (DB Connect)

이후 DB까지 포함한 AMI를 새로새로 갱신하고 오토스케일링 그룹도 새로운 이미지로 업데이트를 하면 완료된다.

## RDS 추가 정보

RDS는 FailOver 설정을 통해 HA 과정을 시험할 수 있다.  
Write Role을 가진 인스턴스에서 FailOver처리를 하면 Reader Role을 가진 인스턴스가 Writer 로 자동으로 변경된다.  

## snapshot

운영중인 RDS 인스턴스의 백업 이미지를 생성한다.  

