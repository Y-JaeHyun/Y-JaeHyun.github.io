---
layout:     post
author:     bcnote3314
title: NextCloud의 데이터 관리?
category: Note
tags: 		Docker&k8s
---

라즈베리파이에 쿠버네티스를 이용하여 NextCloud 컨테이너를 구동시키고 서비스가 구동되는것을 확인했었다.  
이 클라우드 서비스를 정상적으로 이용하기 위해서는 추가적인 설정이 필요하다.  

우선 라즈베리파이는 SD카드를 저장소로 사용하기 떄문에 외장하드를 통해 충분한 용량을 확보 할수 있도록 해야한다.  
또한 컨테이너에서 해당 경로를 기반으로 데이터를 관리할수 있도록 설정을 해줘야 할것 같다.


# Persistent Volume

이전에 도커를 볼떄도 볼륨이라는 단어는 자주 보이는 단어였다.  
쉽게 생각하면 데이터를 저장하는 공간이라고 볼 수 있다.  
별도의 설정이 없다면 일반적으로 /var/lib/docker/volumes 하위 디렉토리에 사용된다.  

실제로 k8s를 통해 NextCloud를 구동한 이후에 저장된 데이터를 찾아보면 해당 경로 하위에 특정 경로에서 검색되는 것을 볼 수 있다. (물론 worker node에서 확인해야한다.)  

```
$ find / -name 'test.png'
/var/lib/docker/volumes/a9652a264e70efe8b94c492643d39a59dcca8f7829490d1f00a6f5543eeeb330/_data/data/wogus3314/files/Photos/test.png
```

볼륨에는 다양한 유형의 형태가 있으며 기본적으로는 임시 볼륨 유형으로 파드의 수명에 따라 관리된다.  
즉 파드가 존재하지 않게 되거나 컨테이너의 재시작 등에 의하여 보존하던 데이터의 유실이 발생할 수 있다.  

클라우드 저장소가 목적이고, 일반적인 서비스를 사용하더라도 데이터의 영속성을 위해서는 퍼시스턴트 볼륨을 생성해야 한다.  

우선 system, data 영역을 분리하여 각각 yml파일을 생성하고 kubectl apply 를 통하여 생성 가능하다.  

- system_pv.yml
```
apiVersion: v1
kind: PersistentVolume
metadata:
  name: pv-nextcloud-system
spec:
  capacity:
    storage: 50Gi
  volumeMode: Filesystem
  accessModes:
    - ReadWriteOnce
    - ReadWriteMany
  storageClassName: nextcloud-system
  persistentVolumeReclaimPolicy: Retain
  hostPath:
    path: /backup/nextcloud-system
```

- data_pv.yml
```
apiVersion: v1
kind: PersistentVolume
metadata:
  name: pv-nextcloud-data
spec:
  capacity:
    storage: 500Gi
  volumeMode: Filesystem
  accessModes:
    - ReadWriteOnce
    - ReadWriteMany
  storageClassName: nextcloud-data
  persistentVolumeReclaimPolicy: Retain
  hostPath:
    path: /backup/nextcloud-data
```


```
$ kubectl apply -f system_pv.yml
persistentvolume/pv-nextcloud-system created

$ kubectl apply -f data_pv.yml
persistentvolume/pv-nextcloud-data created

# kubectl get pv
NAME                  CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS      CLAIM   STORAGECLASS       REASON   AGE
pv-nextcloud-data     500Gi      RWO,RWX        Retain           Available           nextcloud-data              69s
pv-nextcloud-system   50Gi       RWO,RWX        Retain           Available           nextcloud-system            77s

```

